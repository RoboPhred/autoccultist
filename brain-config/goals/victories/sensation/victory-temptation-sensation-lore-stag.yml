name: Aquire the Stag Door and prepare for the Thiatic Invocation
requirements:
  cardSet:
    - elementId: waywhite
    - elementId: fragmentforge
    - elementId: fragmentforge
    - elementId: fragmentforgeb
    - elementId: fragmentknock
    - elementId: fragmentknockb
    - elementId: fragmentlantern
    - elementId: fragmentlantern
    - elementId: fragmentlanternb
    - elementId: fragmentmoth
    - elementId: fragmentmoth
    - elementId: fragmentmothb
    - elementId: fragmentwinter
completedWhen:
  allOf:
    - elementId: waystag_after
    - elementId: fragmentgraild
impulses:
  - name: Aquire the Stag Riddle
    forbidders:
      anyOf:
        - elementId: waystagbefore_1
        - elementId: waystagbefore_2
        - elementId: waystagbefore_3
        - elementId: waystagbefore_4
        - elementId: waystagbefore_5
        - elementId: waystag_after
    operation: !import ../../../operations/mansus/stag/aquire-way-stag-riddle.yml
  - name: Answer Ghirbi's riddle on Moth
    operation: !import ../../../operations/mansus/stag/aquire-way-stag-riddle-1.yml
  - name: Answer Ghirbi's riddle on Lantern
    operation: !import ../../../operations/mansus/stag/aquire-way-stag-riddle-2.yml
  - name: Answer Ghirbi's riddle on Grail
    operation: !import ../../../operations/mansus/stag/aquire-way-stag-riddle-3.yml
  - name: Answer Ghirbi's riddle on Knock
    operation: !import ../../../operations/mansus/stag/aquire-way-stag-riddle-4.yml

  - name: Ensure we have glimmering
    priority: maintenance
    forbidders:
      anyOf:
        - elementId: glimmering
          # It takes 60 seconds for the operation to get to a point where it needs this.
          #  TODO: Should let the operation itself state this requirement.
          lifetimeRemaining:
            greaterThan: 60
    operation: !import ../../../operations/study-passion.yml

  # Begin Knock C
  - name: Subvert Sexton's Secret to Knock
    requirements:
      elementId: waystagbefore_4
    forbidders:
      anyOf:
        - cardSet:
            - elementId: fragmentknockb
            - elementId: fragmentknockb
        - elementId: fragmentknockc
    operation: !import ../../../operations/lore/knock/lore-subvert-winter-knock-a.yml
  - name: Combine An Iguvine Rite
    requirements:
      elementId: waystagbefore_4
    forbidders:
      elementId: fragmentknockc
    operation: !import ../../../operations/lore/knock/lore-combine-knock-b.yml
  # End Knock C
  
  # Begin Grail C
  - name: Combine A Megalesian Incantation
    requirements:
      elementId: waystagbefore_3
    forbidders:
      elementId: fragmentgrailc
    operation: !import ../../../operations/lore/grail/lore-combine-grail-b.yml
  - name: Combine A Red Secret
    requirements:
      elementId: waystagbefore_3
    forbidders:
      anyOf:
        - cardSet:
            - elementId: fragmentgrailb
            - elementId: fragmentgrailb
        - elementId: fragmentgrailc
    operation: !import ../../../operations/lore/grail/lore-combine-grail-a.yml
  # End Grail C

  # Begin Secret Histories C
  - name: Combine A Furtive Truth
    requirements:
      elementId: waystagbefore_5
    forbidders:
      elementId: fragmentsecrethistoriesc
    operation: !import ../../../operations/lore/secrethistories/lore-combine-secrethistories-b.yml
  - name: Combine An Occult Scrap
    requirements:
      elementId: waystagbefore_5
    forbidders:
      anyOf:
        - cardSet:
            - elementId: fragmentsecrethistoriesb
            - elementId: fragmentsecrethistoriesb
        - elementId: fragmentsecrethistoriesc
    operation: !import ../../../operations/lore/secrethistories/lore-combine-secrethistories-a.yml
  # End Secret Histories C

  # Begin Moth / Lantern / Forge juggling
  # moth + lantern = lanternb
  - name: Subvert A Barber's Warning with A Watchman's Secret to get A Mansus-Glimpse
    priority: goal
    operation: !import ../../../operations/lore/lantern/lore-subvert-moth-lantern-a.yml
  # forge + forge = forgeb
  - name: Combine A Smith's Secret for An Ardent Orison
    priority: goal
    operation: !import ../../../operations/lore/forge/lore-combine-forge-a.yml
  # forgeb + lanternb = forgec
  - name: Subvert A Mansus Glimpse to A Shaping Chant
    priority: goal
    forbidders:
      cardSet:
        # Stop at 3
        - elementId: fragmentforgec
        - elementId: fragmentforgec
        - elementId: fragmentforgec
    operation: !import ../../../operations/lore/forge/lore-subvert-lantern-forge-b.yml
  # mothb + lanternb = lanternc
  - name: Subvert A Wood-Whisper to An Unmerciful Mantra
    priority: goal
    forbidders:
      # Only do this once
      elementId: fragmentlanternc
    operation: !import ../../../operations/lore/lantern/lore-subvert-moth-lantern-b.yml
  # End Moth / Lantern / Forge juggling

  # heartc + grailc = graild
  - name: Subvert A Waking Chant for Thiatic Invocation
    priority: goal
    forbidders:
      elementId: waystagbefore_3
    operation: !import ../../../operations/lore/grail/lore-subvert-heart-grail-c.yml