name: Aquire the Stag Door
completedWhen:
  elementId: waystag_after
impulses:
  - name: Aquire the Stag Riddle
    forbidders:
      anyOf:
        - elementId: waystagbefore_1
        - elementId: waystagbefore_2
        - elementId: waystagbefore_3
        - elementId: waystagbefore_4
        - elementId: waystagbefore_5
        - elementId: waystag_after
    operation: !import ../../operations/mansus/stag/aquire-way-stag-riddle.yml
  # FIXME: This is a mess.  We should instead be able to choose goals or motivations based on cards on the board, and have one goal
  #  per riddle type.
  - name: Ensure we have erudition
    priority: maintenance
    requirements:
      anyOf:
        - elementId: waystagbefore_2
        - elementId: waystagbefore_4
        - elementId: waystagbefore_5
    forbidders:
      anyOf:
        - elementId: erudition
          # It takes 60 seconds for the operation to get to a point where it needs this.
          #  TODO: Should let the operation itself state this requirement.
          lifetimeRemaining:
            greaterThan: 60
        - elementId: waystag_after
    operation: !import ../../operations/study-reason.yml
  - name: Ensure we have glimmering
    priority: maintenance
    requirements:
      anyOf:
        - elementId: waystagbefore_3
        - elementId: waystagbefore_4
    forbidders:
      anyOf:
        - elementId: glimmering
          # It takes 60 seconds for the operation to get to a point where it needs this.
          #  TODO: Should let the operation itself state this requirement.
          lifetimeRemaining:
            greaterThan: 60
        - elementId: waystag_after
    operation: !import ../../operations/study-passion.yml
  # Begin Riddle 1: Moth
  #  Assuming we cleaned out morland, we should already have a fragmentmothc.
  - name: Answer Ghirbi's riddle on Moth
    operation: !import ../../operations/mansus/stag/aquire-way-stag-riddle-1.yml
  # Begin Riddle 2: Lantern
  - name: Combine A Mansus Glimpse
    requirements:
      elementId: waystagbefore_2
    forbidders:
      elementId: fragmentlanternc
    operation: !import ../../operations/lore/lantern/lore-combine-lantern-b.yml
  - name: Combine A Watchman's Secret
    requirements:
      elementId: waystagbefore_2
    forbidders:
      anyOf:
        - cardSet:
            - elementId: fragmentlanternb
            - elementId: fragmentlanternb
        - elementId: fragmentlanternc
    operation: !import ../../operations/lore/lantern/lore-combine-lantern-a.yml
  - name: Answer Ghirbi's riddle on Lantern
    operation: !import ../../operations/mansus/stag/aquire-way-stag-riddle-2.yml
  # Begin Riddle 3: Grail
  - name: Combine A Megalesian Incantation
    requirements:
      elementId: waystagbefore_3
    forbidders:
      elementId: fragmentgrailc
    operation: !import ../../operations/lore/grail/lore-combine-grail-b.yml
  - name: Combine A Red Secret
    requirements:
      elementId: waystagbefore_3
    forbidders:
      anyOf:
        - cardSet:
            - elementId: fragmentgrailb
            - elementId: fragmentgrailb
        - elementId: fragmentgrailc
    operation: !import ../../operations/lore/grail/lore-combine-grail-a.yml
  - name: Answer Ghirbi's riddle on Grail
    operation: !import ../../operations/mansus/stag/aquire-way-stag-riddle-3.yml
  # Begin Riddle 4: Knock
  # FIXME: This works, but burns up lantern, which we need to upgrade our forge lore.
  # - name: Combine An Iguvine Rite
  #   requirements:
  #     elementId: waystagbefore_4
  #   forbidders:
  #     elementId: fragmentknockc
  #   operation: !import ../../operations/lore/knock/lore-combine-knock-b.yml
  # - name: Subvert A Mansus Glimpse to An Iguvine Rite
  #   requirements:
  #     elementId: waystagbefore_4
  #   forbidders:
  #     anyOf:
  #       - cardSet:
  #           - elementId: fragmentknockb
  #           - elementId: fragmentknockb
  #       - elementId: fragmentknockc
  #   operation: !import ../../operations/lore/knock/lore-subvert-lantern-knock-b.yml
  # - name: Combine A Locksmith's Secret
  #   requirements:
  #     elementId: waystagbefore_4
  #   forbidders:
  #     anyOf:
  #       - cardSet:
  #           - elementId: fragmentknockb
  #           - elementId: fragmentknockb
  #       - elementId: fragmentknockc
  #   operation: !import ../../operations/lore/knock/lore-combine-knock-a.yml
  # - name: Subvert A Watchman's Secret to A Locksmith's Secret
  #   requirements:
  #     elementId: waystagbefore_4
  #   forbidders:
  #     anyOf:
  #       - cardSet:
  #           - elementId: fragmentknockb
  #           - elementId: fragmentknockb
  #       - cardSet:
  #           - elementId: fragmentknock
  #           - elementId: fragmentknock
  #       - elementId: fragmentknockc
  #   operation: !import ../../operations/lore/knock/lore-subvert-lantern-knock-a.yml
  - name: Answer Ghirbi's riddle on Knock
    operation: !import ../../operations/mansus/stag/aquire-way-stag-riddle-4.yml
  # Begin Riddle 5: Secret Histories
  - name: Combine A Furtive Truth
    requirements:
      elementId: waystagbefore_5
    forbidders:
      elementId: fragmentsecrethistoriesc
    operation: !import ../../operations/lore/secrethistories/lore-combine-secrethistories-b.yml
  - name: Combine An Occult Scrap
    requirements:
      elementId: waystagbefore_5
    forbidders:
      anyOf:
        - cardSet:
            - elementId: fragmentsecrethistoriesb
            - elementId: fragmentsecrethistoriesb
        - elementId: fragmentsecrethistoriesc
    operation: !import ../../operations/lore/secrethistories/lore-combine-secrethistories-a.yml
  - name: Answer Ghirbi's riddle on Secret Histories
    operation: !import ../../operations/mansus/stag/aquire-way-stag-riddle-5.yml
