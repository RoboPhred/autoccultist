sharedImperatives:
  - &imp-maint-work-health
    name: Work with health
    priority: maintenance
    forbidders: &forbid-during-illhealth
      anyOf:
        - # Forbid if ill health is occuring
          # TODO: Should only forbid if ongoing slot Affliction is empty
          situation: illhealth
        - # forbid when situation time contains stored stack seasonsickness and it has < 30 seconds remainming in its recipe
          situation: time
          storedCardsMatch:
            - elementId: seasonsickness
          timeRemaining:
            lessThan: 30
    operation: !import operations/work-health.yml
  - &imp-crit-heal-injury
    name: Heal injury with funds
    priority: critical
    operation: !import operations/heal-injury-with-funds.yml
  - &imp-crit-heal-affliction
    name: Heal affliction with funds
    priority: critical
    operation: !import operations/heal-affliction-with-funds.yml
  - &imp-crit-dispose-restlessness
    name: Paint away restlessness
    priority: critical
    operation: !import operations/paint-away-restlessness.yml
  - &imp-maint-refresh-health
    name: Refresh health
    priority: maintenance
    operation: !import operations/refresh-health.yml
  - &imp-goal-vitality-lesson
    name: Learn lesson from vitality
    priority: goal
    operation: !import operations/learn-vitality-lesson.yml
  - &imp-vitality-from-health
    name: Gain vitality from health
    priority: maintenance
    forbidders: *forbid-during-illhealth
    operation: !import operations/study-health.yml

goals:
  - name: Begin the Intro
    requirements:
      elementId: introjob
    completedWhen:
      elementId: bequestintro
    imperatives:
      - name: Work the intro job
        priority: goal
        operation:
          situation: work
          startingRecipe:
            slots:
              work:
                elementId: introjob
  - name: Study Bequest
    requirements:
      elementId: bequestintro
    completedWhen:
      anyOf:
        - elementId: ascensionpowera
        - elementId: ascensionenlightenmenta
        - elementId: ascensionsensationa
    imperatives:
      - name: Study the Bequest
        priority: goal
        operation:
          situation: study
          startingRecipe:
            slots:
              study:
                elementId: bequestintro
              Approach:
                elementId: passion
  - name: Find a Collaborator
    requirements:
      elementId: contactintro
    completedWhen:
      allOf:
        - aspects:
            acquaintance: 1
    imperatives:
      - *imp-maint-work-health
      - *imp-crit-heal-injury
      - *imp-crit-dispose-restlessness
      - *imp-crit-heal-affliction
      - *imp-maint-refresh-health
      - name: Contact Collaborator
        priority: goal
        operation:
          situation: study
          startingRecipe:
            slots:
              study:
                elementId: contactintro
  - name: Wait for health refresh
    requirements:
      # TODO: This is too vague, it might kick in instead of Survive if we have a fatigue around
      #  That is typically ok, but we might want to be able to retire goals after they are completed
      #  Or have them stick to an ordered list, skipping the ones that dont apply at the time.
      elementId: fatigue
    completedWhen:
      allOf:
        - elementId: health
    imperatives:
      - *imp-maint-refresh-health
  - name: Get Health skill A
    requirements:
      allOf:
        - elementId: health
    completedWhen:
      anyOf:
        - elementId: skillhealtha
        - elementId: skillhealthb
        - elementId: skillhealthc
        - elementId: skillhealthd_strength
        - elementId: skillhealthd_grace
    imperatives:
      - *imp-maint-work-health
      - *imp-crit-heal-injury
      - *imp-crit-dispose-restlessness
      - *imp-crit-heal-affliction
      - *imp-maint-refresh-health
      - *imp-goal-vitality-lesson
  - name: Get Health skill B
    requirements:
      elementId: skillhealtha
    completedWhen:
      anyOf:
        - elementId: skillhealthb
        - elementId: skillhealthc
        - elementId: skillhealthd_strength
        - elementId: skillhealthd_grace
    imperatives:
      - *imp-maint-refresh-health
      - *imp-crit-dispose-restlessness
      - *imp-crit-heal-affliction
      - *imp-crit-heal-injury
      - *imp-vitality-from-health
      - <<: *imp-goal-vitality-lesson
        forbidders:
          # Do not monopolize study when we have vitality lessons to study
          cardSet:
            - elementId: vitalityplus
            - elementId: vitalityplus
      - name: Stronger Physique work
        priority: maintenance
        operation: !import operations/work-skillhealtha.yml
        forbidders:
          # Don't steal away our health skill card when we need it to upgrade.
          cardSet:
            - elementId: vitalityplus
            - elementId: vitalityplus
      - name: Upgrade Stronger Physique to Hardened Physique
        priority: goal
        operation: !import operations/upgrade-skillhealtha.yml
  - name: Get Health skill C
    requirements:
      allOf:
        - elementId: skillhealthb
    completedWhen:
      anyOf:
        - elementId: skillhealthc
        - elementId: skillhealthd_strength
        - elementId: skillhealthd_grace
    imperatives:
      - *imp-maint-refresh-health
      - *imp-crit-dispose-restlessness
      - *imp-crit-heal-affliction
      - *imp-crit-heal-injury
      - *imp-vitality-from-health
      - <<: *imp-goal-vitality-lesson
        forbidders:
          # Stop gaining lessons when we have enough
          cardSet:
            - elementId: vitalityplus
            - elementId: vitalityplus
            - elementId: vitalityplus
      - name: Hardened Physique work
        priority: maintenance
        operation: !import operations/work-skillhealthb.yml
        forbidders:
          # Stop using our skill card when we have enough lessons
          cardSet:
            - elementId: vitalityplus
            - elementId: vitalityplus
            - elementId: vitalityplus
      - name: Upgrade Hardened Physique to Steely Physique
        priority: goal
        operation: !import operations/upgrade-skillhealthb.yml
  - name: Survive
    requirements:
      elementId: skillhealthc
    imperatives:
      - *imp-maint-refresh-health
      - *imp-crit-dispose-restlessness
      - *imp-crit-heal-affliction
      - *imp-crit-heal-injury
      - name: Steely Physique work
        priority: maintenance
        operation: !import operations/work-skillhealthc.yml
